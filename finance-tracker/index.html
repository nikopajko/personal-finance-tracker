<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif; 
            background: #f7f7f5;
            color: #37352f;
            line-height: 1.6;
        }
        
        /* Navigation */
        .nav { 
            background: white;
            border-bottom: 1px solid #e9e9e7;
            padding: 16px 32px;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .nav h1 { 
            font-size: 16px;
            font-weight: 600;
            color: #37352f;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .year-selector select {
            padding: 6px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .year-btn {
            padding: 6px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            color: #37352f;
        }
        
        .year-btn:hover {
            background: #f7f7f5;
        }
        
        .year-btn.export {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }
        
        .year-btn.export:hover {
            background: #005a9e;
        }
        
        #import-file {
            display: none;
        }
        
        .nav-buttons { 
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #e9e9e7;
            overflow-x: auto;
        }
        
        .nav-btn { 
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #787774;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            font-weight: 500;
        }
        
        .nav-btn:hover { 
            color: #37352f;
            background: #f7f7f5;
        }
        
        .nav-btn.active { 
            color: #37352f;
            border-bottom-color: #37352f;
            background: #e9e9e7;
            font-weight: 600;
        }
        
        /* Container */
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            padding: 48px 32px;
        }
        
        /* Cards */
        .card { 
            background: white;
            border-radius: 4px;
            padding: 40px;
            border: 1px solid #e9e9e7;
            margin-bottom: 32px;
        }
        
        .card h2 { 
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #37352f;
        }
        
        .card p { 
            color: #787774;
            margin-bottom: 32px;
            font-size: 14px;
        }
        
        /* Section headers */
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #37352f;
            margin-bottom: 16px;
            margin-top: 32px;
        }
        
        .section-header:first-child {
            margin-top: 0;
        }
        
        /* Metrics */
        .metrics { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .metric { 
            padding: 20px;
            background: #f7f7f5;
            border-radius: 4px;
            border: 1px solid #e9e9e7;
        }
        
        .metric-label { 
            font-size: 12px;
            color: #787774;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .metric-value { 
            font-size: 28px;
            font-weight: 600;
            color: #37352f;
        }
        
        .metric-subtext {
            font-size: 12px;
            color: #787774;
            margin-top: 8px;
        }
        
        /* Color variants */
        .metric.blue .metric-value { color: #0078d4; }
        .metric.red .metric-value { color: #dc3545; }
        .metric.green .metric-value { color: #28a745; }
        .metric.purple .metric-value { color: #6f42c1; }
        
        /* Forms */
        input, select, textarea { 
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            transition: border-color 0.15s;
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none;
            border-color: #0078d4;
        }
        
        /* Remove number spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="number"].table-input {
            padding: 4px 6px;
            font-size: 12px;
            text-align: right;
            min-width: 85px;
        }
        
        textarea.table-input {
            padding: 4px 8px;
            font-size: 13px;
            min-height: 32px;
        }
        
        .form-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .form-group { 
            margin-bottom: 24px;
        }
        
        label { 
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #37352f;
        }
        
        /* Sections */
        .section { 
            padding: 24px;
            background: #f7f7f5;
            border-radius: 4px;
            margin-bottom: 24px;
            border: 1px solid #e9e9e7;
        }
        
        .section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #37352f;
        }
        
        /* Tables */
        table { 
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th, td { 
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #e9e9e7;
        }
        
        th { 
            background: #f7f7f5;
            font-weight: 600;
            color: #37352f;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover { 
            background: #fafaf9;
        }
        
        tr.empty-row {
            opacity: 0.5;
        }
        
        tr.empty-row td {
            font-style: italic;
            color: #9ca3af;
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.15s;
        }
        
        .btn-primary { 
            background: #37352f;
            color: white;
        }
        
        .btn-primary:hover { 
            background: #2c2a27;
        }
        
        .btn-secondary {
            background: white;
            color: #37352f;
            border: 1px solid #e9e9e7;
        }
        
        .btn-secondary:hover {
            background: #f7f7f5;
        }
        
        .btn-danger { 
            background: white;
            color: #dc3545;
            border: 1px solid #e9e9e7;
            font-size: 13px;
            padding: 6px 12px;
        }
        
        .btn-danger:hover { 
            background: #fff5f5;
            border-color: #dc3545;
        }
        
        /* Status indicators */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.success {
            background: #e8f5e9;
            color: #28a745;
        }
        
        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.empty {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        /* Summary boxes */
        .summary-box {
            padding: 20px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9e9e7;
            margin-top: 16px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .summary-row:last-child {
            margin-bottom: 0;
        }
        
        .summary-label {
            font-size: 14px;
            color: #787774;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: #37352f;
        }
        
        /* Progress bars */
        .progress-container {
            margin-top: 8px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #787774;
            margin-bottom: 6px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9e9e7;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #0078d4;
            transition: width 0.3s;
        }
        
        .progress-fill.success { background: #28a745; }
        .progress-fill.danger { background: #dc3545; }
        
        /* Quarterly grid */
        .quarterly-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }
        
        @media (max-width: 900px) {
            .quarterly-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Utilities */
        .hidden { display: none; }
        
        .text-center { text-align: center; }
        
        .text-right { text-align: right; }
        
        .divider {
            height: 1px;
            background: #e9e9e7;
            margin: 32px 0;
        }
        
        /* Footer */
        .footer { 
            background: white;
            border-top: 1px solid #e9e9e7;
            text-align: center;
            padding: 24px;
            margin-top: 64px;
            color: #787774;
            font-size: 13px;
        }
        
        /* Currency formatted inputs */
        input.currency-formatted {
            position: relative;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #37352f;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #37352f transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }
            
            .card {
                padding: 24px;
            }
            
            .nav {
                padding: 16px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="nav">
        <div class="nav-container">
            <div class="nav-header">
                <h1>Financial Tracker</h1>
                <div class="year-selector">
                    <select id="year-select" onchange="handleYearChange(this.value)"></select>
                    <div style="width: 1px; height: 24px; background: #e9e9e7; margin: 0 8px;"></div>
                    <button class="year-btn" onclick="document.getElementById('import-file').click()" title="Import a previously exported backup file">⬆ Import</button>
                    <button class="year-btn export" onclick="exportData()" title="Download a backup of all your data">⬇ Export</button>
                    <input type="file" id="import-file" accept=".json" onchange="importData(event)">
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('overview', this)">🏠 Overview</button>
                <button class="nav-btn" onclick="showSection('monthly', this)">Monthly Tracker</button>
                <button class="nav-btn" onclick="showSection('networth', this)">Net Worth</button>
                <button class="nav-btn" onclick="showSection('quarterly', this)">Quarterly</button>
                <button class="nav-btn" onclick="showSection('subscriptions', this)">Subscriptions</button>
                <button class="nav-btn" onclick="showSection('setup', this)">Goals & Setup</button>
                <button class="nav-btn" onclick="showSection('help', this)">Help</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- SETUP -->
        <div id="setup-section" class="card hidden">
            <h2>Goals & Setup</h2>
            <p>Configure your financial targets for <span class="current-year">2026</span></p>

            <div class="section-header">Income Settings</div>
            <div class="form-grid">
                <div>
                    <label>Expected Monthly Income</label>
                    <input type="number" id="setup-salary" value="5545" onchange="saveSetup()">
                </div>
                <div>
                    <label>Target Savings Rate (%)</label>
                    <input type="number" id="setup-rate" value="25" onchange="saveSetup()">
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Annual Goals</div>
            <div class="form-grid">
                <div>
                    <label>Annual Travel Budget</label>
                    <input type="number" id="setup-travel" value="3000" onchange="saveSetup()">
                </div>
                <div>
                    <label>Starting Net Worth (Jan 1)</label>
                    <input type="number" id="setup-networth" value="99160" onchange="saveSetup()">
                </div>
            </div>

            <div class="summary-box" style="background: #e8f5e9; border-color: #28a745;">
                <div style="color: #28a745; font-size: 14px; font-weight: 500;">All changes saved automatically</div>
            </div>
        </div>

        <!-- MONTHLY TRACKER -->
        <div id="monthly-section" class="card hidden">
            <h2>Monthly Tracker</h2>
            <p>Track income and expenses throughout <span class="current-year">2026</span> - edit directly in the table</p>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-header" style="margin: 0;">Monthly Details</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('csv-import-file').click()">Import CSV</button>
                    <button class="btn btn-secondary" onclick="downloadCSVTemplate()">Download Template</button>
                    <button class="btn btn-secondary" onclick="manageColumns()">Manage Columns</button>
                    <button class="btn btn-danger" onclick="clearMonthlyData()" title="Clear all monthly data (reversible with Cmd-Z)">Clear All</button>
                </div>
                <input type="file" id="csv-import-file" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>

            <div style="overflow-x: auto;">
                <table id="monthly-table">
                    <thead id="monthly-thead"></thead>
                    <tbody id="monthly-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- NET WORTH -->
        <div id="networth-section" class="card hidden">
            <h2>Net Worth Tracker</h2>
            <p>Track your wealth growth in <span class="current-year">2026</span></p>

            <div class="metrics">
                <div class="metric blue">
                    <div class="metric-label tooltip">Current Net Worth
                        <span class="tooltiptext">Total value of all your accounts and assets</span>
                    </div>
                    <div class="metric-value" id="nw-current">$99,160</div>
                </div>
                <div class="metric purple">
                    <div class="metric-label tooltip">Starting Balance
                        <span class="tooltiptext">Your net worth at the beginning of the year</span>
                    </div>
                    <div class="metric-value" id="nw-starting">$99,160</div>
                </div>
                <div class="metric green">
                    <div class="metric-label tooltip">Growth
                        <span class="tooltiptext">Change in net worth from the start of the year</span>
                    </div>
                    <div class="metric-value" id="nw-growth">$0</div>
                </div>
                <div class="metric">
                    <div class="metric-label tooltip">Growth Rate
                        <span class="tooltiptext">Percentage increase in net worth from the start of the year</span>
                    </div>
                    <div class="metric-value" id="nw-rate">0%</div>
                </div>
            </div>

            <div class="divider"></div>
            
            <div class="section-header">Net Worth Growth</div>
            <div style="background: white; padding: 24px; border-radius: 4px; border: 1px solid #e9e9e7; margin-bottom: 24px;">
                <canvas id="networth-chart" style="max-height: 300px;"></canvas>
            </div>

            <div class="divider"></div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-header" style="margin: 0;">Account Categories</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="addNWField()">Add Account</button>
                    <button class="btn btn-danger" onclick="clearNetWorthData()" title="Clear all net worth balances (reversible with Cmd-Z)">Clear All</button>
                </div>
            </div>

            <div id="nw-field-manager"></div>

            <div class="divider"></div>

            <div style="overflow-x: auto;">
                <table id="nw-table">
                    <thead id="nw-thead"></thead>
                    <tbody id="nw-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- OVERVIEW -->
        <div id="overview-section" class="card">
            <h2>Annual Overview</h2>
            <p>Complete financial summary for <span class="current-year">2026</span></p>
            
            <div class="metrics">
                <div class="metric blue">
                    <div class="metric-label tooltip">Total Income
                        <span class="tooltiptext">Sum of all income sources including salary, transfers received, and other deposits</span>
                    </div>
                    <div class="metric-value" id="o-income">$0</div>
                </div>
                <div class="metric red">
                    <div class="metric-label tooltip">Total Expenses
                        <span class="tooltiptext">Sum of all expense categories including rent, transfers sent, debit withdrawals, and credit expenses</span>
                    </div>
                    <div class="metric-value" id="o-expenses">$0</div>
                </div>
                <div class="metric green">
                    <div class="metric-label tooltip">Total Saved
                        <span class="tooltiptext">Net income minus total expenses - the amount you kept from your income</span>
                    </div>
                    <div class="metric-value" id="o-saved">$0</div>
                </div>
                <div class="metric purple">
                    <div class="metric-label tooltip">Savings Rate
                        <span class="tooltiptext">Percentage of income saved, calculated as (Net Saved ÷ Total Income) × 100</span>
                    </div>
                    <div class="metric-value" id="o-rate">0%</div>
                    <div class="metric-subtext">Target: <span id="o-target-rate">25</span>%</div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Performance Metrics</div>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-label tooltip">Avg Monthly Income
                        <span class="tooltiptext">Average income per month based on logged months</span>
                    </div>
                    <div class="metric-value" id="o-avg-income">$0</div>
                </div>
                <div class="metric">
                    <div class="metric-label tooltip">Avg Monthly Expenses
                        <span class="tooltiptext">Average expenses per month based on logged months</span>
                    </div>
                    <div class="metric-value" id="o-avg-expenses">$0</div>
                </div>
                <div class="metric">
                    <div class="metric-label tooltip">Avg Monthly Saved
                        <span class="tooltiptext">Average net savings per month based on logged months</span>
                    </div>
                    <div class="metric-value" id="o-avg-saved">$0</div>
                </div>
                <div class="metric">
                    <div class="metric-label tooltip">Months Logged
                        <span class="tooltiptext">Number of months with data entered</span>
                    </div>
                    <div class="metric-value" id="o-months">0</div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Savings Goal Progress</div>
            <div class="section">
                <div class="metrics">
                    <div>
                        <div class="metric-label tooltip">Annual Target
                            <span class="tooltiptext">Expected annual savings based on your target savings rate</span>
                        </div>
                        <div style="font-size: 20px; font-weight: 600; color: #37352f;" id="o-goal-target">$0</div>
                    </div>
                    <div>
                        <div class="metric-label tooltip">Actual Saved
                            <span class="tooltiptext">Total amount saved so far this year</span>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;" id="o-goal-actual">$0</div>
                    </div>
                    <div>
                        <div class="metric-label tooltip">Projected Annual
                            <span class="tooltiptext">Estimated full-year savings based on current monthly average</span>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;" id="o-goal-projected">$0</div>
                    </div>
                    <div>
                        <div class="metric-label tooltip">Variance
                            <span class="tooltiptext">Difference between projected savings and target savings</span>
                        </div>
                        <div style="font-size: 20px; font-weight: 600;" id="o-goal-variance">$0</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Progress to Annual Target</span>
                        <span id="o-goal-pct">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill success" id="o-goal-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Travel Budget</div>
            <div class="section">
                <div class="metrics">
                    <div>
                        <div class="metric-label">Budget</div>
                        <div style="font-size: 20px; font-weight: 600; color: #37352f;" id="o-travel-budget">$0</div>
                    </div>
                    <div>
                        <div class="metric-label">Spent</div>
                        <div style="font-size: 20px; font-weight: 600;" id="o-travel-spent">$0</div>
                    </div>
                    <div>
                        <div class="metric-label">Remaining</div>
                        <div style="font-size: 20px; font-weight: 600;" id="o-travel-remaining">$0</div>
                    </div>
                    <div>
                        <div class="metric-label">Status</div>
                        <div id="o-travel-status" class="status-badge success">On Budget</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Budget Used</span>
                        <span id="o-travel-pct">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="o-travel-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Monthly Breakdown</div>
            <div style="overflow-x: auto;">
                <table id="overview-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th class="text-right">Income</th>
                            <th class="text-right">Expenses</th>
                            <th class="text-right">Travel</th>
                            <th class="text-right">Subscriptions</th>
                            <th class="text-right">Net Saved</th>
                            <th class="text-right">Rate %</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="overview-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- QUARTERLY -->
        <div id="quarterly-section" class="card hidden">
            <h2>Quarterly Review</h2>
            <p>Track your progress quarter by quarter in <span class="current-year">2026</span></p>

            <div class="quarterly-grid">
                <div id="q1-card"></div>
                <div id="q2-card"></div>
                <div id="q3-card"></div>
                <div id="q4-card"></div>
            </div>
        </div>

        <!-- SUBSCRIPTIONS -->
        <div id="subscriptions-section" class="card hidden">
            <h2>Subscription Manager</h2>
            <p>Track recurring expenses (reference this tab when manually entering subscriptions in Monthly Tracker)</p>

            <div class="metrics">
                <div class="metric red">
                    <div class="metric-label">Monthly Total</div>
                    <div class="metric-value" id="sub-monthly">$0</div>
                </div>
                <div class="metric purple">
                    <div class="metric-label">Annual Total</div>
                    <div class="metric-value" id="sub-annual">$0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Active Subscriptions</div>
                    <div class="metric-value" id="sub-count">0</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-header" style="margin: 0;">Your Subscriptions</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" onclick="addSubscription()">Add Subscription</button>
                    <button class="btn btn-danger" onclick="clearSubscriptions()" title="Delete all subscriptions (reversible with Cmd-Z)">Clear All</button>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="text-right">Monthly Cost</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Cancellation Link</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sub-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- HELP -->
        <div id="help-section" class="card hidden">
            <h2>Help & Instructions</h2>
            <p>Everything you need to know about using your Financial Tracker</p>

            <div class="section-header">Getting Started</div>
            <div class="section">
                <ol style="line-height: 2; margin-left: 20px;">
                    <li><strong>Setup:</strong> Configure your expected monthly income, savings rate target, and annual goals</li>
                    <li><strong>Monthly Tracker:</strong> Enter your actual income and expenses each month directly in the table</li>
                    <li><strong>Net Worth:</strong> Update your account balances monthly to track wealth growth</li>
                    <li><strong>Review:</strong> Check Overview, Quarterly, and other tabs to analyze your progress</li>
                </ol>
            </div>

            <div class="divider"></div>

            <div class="section-header">Backup Your Data</div>
            <div class="section">
                <p style="margin-bottom: 16px; color: #dc3545; font-weight: 500;">⚠️ Your data is stored in your browser's localStorage. Always maintain backups!</p>
                
                <h4 style="font-weight: 600; margin-bottom: 12px;">Export (Backup)</h4>
                <ul style="line-height: 2; margin-left: 20px; margin-bottom: 20px;">
                    <li>Click "⬇ Export Data" button in the top right</li>
                    <li>Saves a JSON file with ALL your data (all years)</li>
                    <li>Save this file to Google Drive, Dropbox, or cloud storage</li>
                    <li>Do this monthly or after major updates</li>
                </ul>

                <h4 style="font-weight: 600; margin-bottom: 12px;">Import (Restore)</h4>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>Click "⬆ Import Data" button</li>
                    <li>Select your backup JSON file</li>
                    <li>Confirms before overwriting current data</li>
                    <li>All your data will be restored</li>
                </ul>
            </div>

            <div class="divider"></div>

            <div class="section-header">Bulk Import from Spreadsheet</div>
            <div class="section">
                <p style="margin-bottom: 16px;">Want to import multiple months of data at once from Excel or Google Sheets?</p>
                
                <h4 style="font-weight: 600; margin-bottom: 12px;">Steps:</h4>
                <ol style="line-height: 2; margin-left: 20px; margin-bottom: 20px;">
                    <li>Go to Monthly Tracker tab</li>
                    <li>Click "Download Template" to get a CSV template file</li>
                    <li>Open the template in Excel or Google Sheets</li>
                    <li>Fill in your data (follow the column headers exactly)</li>
                    <li>Save as CSV file</li>
                    <li>Click "Import CSV" and select your file</li>
                </ol>

                <p style="color: #787774; font-style: italic; margin-top: 12px;">Note: CSV import will overwrite any existing data for the months you're importing. Make sure to export a backup first!</p>
            </div>

            <div class="divider"></div>

            <div class="section-header">Metric Definitions</div>
            <div class="section">
                <div style="margin-bottom: 16px;">
                    <strong>Total Income:</strong>
                    <p style="color: #787774; margin-top: 4px;">Sum of all income sources (salary, transfers, deposits, etc.)</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Total Expenses:</strong>
                    <p style="color: #787774; margin-top: 4px;">Sum of all expense categories (rent, transfers sent, debit, credit card). Does NOT include travel or subscriptions.</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Net Saved (Net Income):</strong>
                    <p style="color: #787774; margin-top: 4px;">Total Income minus Total Expenses. The amount you kept from your income.</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Savings Rate:</strong>
                    <p style="color: #787774; margin-top: 4px;">Percentage of income saved. Calculated as: (Net Saved ÷ Total Income) × 100</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Travel & Subscriptions:</strong>
                    <p style="color: #787774; margin-top: 4px;">Tracked separately for visibility but NOT included in Total Expenses or Savings Rate calculations. These are for tracking purposes only.</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Net Worth:</strong>
                    <p style="color: #787774; margin-top: 4px;">Sum of all your account balances (checking, savings, investments, cash, etc.)</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <strong>Projected Annual Savings:</strong>
                    <p style="color: #787774; margin-top: 4px;">Based on your average monthly savings multiplied by 12. Updates as you log more months.</p>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section-header">Tips & Best Practices</div>
            <div class="section">
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>Update Monthly Tracker within a few days of month end for accuracy</li>
                    <li>Update Net Worth on the same day each month (e.g., 1st of the month)</li>
                    <li>Use the Subscriptions tab as a reference when entering subscription costs monthly</li>
                    <li>Export your data monthly - clearing browser data will erase localStorage</li>
                    <li>Use Notes field in Monthly Tracker for context (e.g., "bonus received", "medical emergency")</li>
                    <li>Check Overview tab to see if you're on track with annual goals</li>
                    <li>Quarterly tab helps identify seasonal patterns in spending/income</li>
                </ul>
            </div>

            <div class="divider"></div>

            <div class="section-header">Multi-Year Tracking</div>
            <div class="section">
                <p style="margin-bottom: 16px;">Use the year dropdown to switch between years or add new years.</p>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>Click "+ Add Year" to create a new year (e.g., 2026, 2027)</li>
                    <li>Each year has independent data and settings</li>
                    <li>Compare year-over-year performance in Overview tab</li>
                    <li>Export includes ALL years - one backup protects everything</li>
                </ul>
            </div>

            <div class="divider"></div>

            <div class="section-header">Data Privacy</div>
            <div class="section">
                <p style="line-height: 1.8;">Your financial data never leaves your browser. Everything is stored locally in your browser's localStorage. No data is sent to any server, cloud, or third party. You have complete control and privacy over your information.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Financial Tracker — All data saved locally in your browser</p>
    </div>

    <script>
        const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        
        // Undo functionality
        let undoHistory = [];
        const MAX_UNDO_HISTORY = 10;
        
        function saveStateForUndo() {
            undoHistory.push(JSON.stringify(allData));
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
        }
        
        function handleUndo(event) {
            // Check if Ctrl+Z or Cmd+Z
            if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
                event.preventDefault();
                if (undoHistory.length > 0) {
                    const previousState = undoHistory.pop();
                    allData = JSON.parse(previousState);
                    saveData();
                    loadCurrentSection();
                }
            }
        }
        
        // Add global keyboard listener for undo
        document.addEventListener('keydown', handleUndo);
        
        const DEFAULT_INCOME_LABELS = ['Salary', 'E-Transfers Received', 'Other Debit Deposits', 'Other Income'];
        const DEFAULT_EXPENSE_LABELS = ['Rent/Housing', 'E-Transfers Sent', 'Other Debit Withdrawals', 'Credit Expenses', 'Other Expenses'];
        const DEFAULT_NW_LABELS = ['Scotia Checking', 'Scotia Savings', 'Cash', 'Wealthsimple', 'Other'];
        
        let currentYear = new Date().getFullYear();
        let allData = {};

        function getDefaultYearData() {
            return {
                setup: {
                    salary: 0,
                    rate: 0,
                    travel: 0,
                    networth: 0
                },
                fieldLabels: {
                    income: [...DEFAULT_INCOME_LABELS],
                    expense: [...DEFAULT_EXPENSE_LABELS]
                },
                monthly: MONTHS.map(m => ({
                    month: m,
                    income: [0, 0, 0, 0],
                    expense: [0, 0, 0, 0, 0],
                    travel: 0,
                    subscriptions: 0,
                    notes: ''
                })),
                networth: MONTHS.map((m, i) => ({
                    month: m,
                    accounts: [0, 0, 0, 0, 0]
                })),
                nwLabels: [...DEFAULT_NW_LABELS],
                subs: []
            };
        }

        function loadData() {
            const saved = localStorage.getItem('financialTrackerMultiYear');
            if (saved) {
                try {
                    allData = JSON.parse(saved);
                    // Migration from old single-year format
                    const oldData = localStorage.getItem('financialTracker2026');
                    if (oldData && !allData['2026']) {
                        const old = JSON.parse(oldData);
                        if (old.monthly && old.monthly[0].salary !== undefined) {
                            old.monthly = old.monthly.map(m => ({
                                month: m.month,
                                income: [m.salary || 0, m.ein || 0, m.otherdep || 0, m.otherinc || 0],
                                expense: [m.rent || 0, m.eout || 0, m.otherdeb || 0, m.credit || 0],
                                travel: m.travel || 0,
                                subscriptions: 0,
                                notes: m.notes || ''
                            }));
                        }
                        if (old.networth && old.networth[0].check !== undefined) {
                            old.networth = old.networth.map(nw => ({
                                month: nw.month,
                                accounts: [nw.check || 0, nw.save || 0, nw.cash || 0, nw.ws || 0, nw.other || 0]
                            }));
                        }
                        allData['2026'] = old;
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
            
            if (!allData[currentYear]) {
                allData[currentYear] = getDefaultYearData();
            }
        }

        function saveData() {
            localStorage.setItem('financialTrackerMultiYear', JSON.stringify(allData));
        }

        function getData() {
            return allData[currentYear] || getDefaultYearData();
        }

        function initYearSelector() {
            const select = document.getElementById('year-select');
            select.innerHTML = '';
            
            const years = Object.keys(allData).sort().reverse();
            if (years.length === 0) {
                years.push(currentYear.toString());
            }
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.selected = year == currentYear;
                select.appendChild(option);
            });
            
            // Add separator and "Add New Year" option
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            select.appendChild(separator);
            
            const addOption = document.createElement('option');
            addOption.value = 'ADD_NEW';
            addOption.textContent = '+ Add New Year';
            select.appendChild(addOption);
        }

        function handleYearChange(value) {
            if (value === 'ADD_NEW') {
                addNewYear();
                return;
            }
            switchYear(value);
        }
        
        function switchYear(year) {
            currentYear = parseInt(year);
            if (!allData[currentYear]) {
                allData[currentYear] = getDefaultYearData();
            }
            updateAllYearLabels();
            loadCurrentSection();
        }

        function addNewYear() {
            const year = prompt('Enter year to add (e.g., 2027):');
            if (year && /^\d{4}$/.test(year)) {
                const y = parseInt(year);
                if (!allData[y]) {
                    allData[y] = getDefaultYearData();
                    currentYear = y;
                    saveData();
                    initYearSelector();
                    updateAllYearLabels();
                    loadCurrentSection();
                } else {
                    alert('Year already exists');
                    // Reset dropdown to current year
                    document.getElementById('year-select').value = currentYear;
                }
            } else if (year !== null) {
                alert('Please enter a valid 4-digit year');
                // Reset dropdown to current year
                document.getElementById('year-select').value = currentYear;
            } else {
                // User cancelled - reset dropdown to current year
                document.getElementById('year-select').value = currentYear;
            }
        }

        function updateAllYearLabels() {
            document.querySelectorAll('.current-year').forEach(el => {
                el.textContent = currentYear;
            });
        }

        function loadCurrentSection() {
            const activeBtn = document.querySelector('.nav-btn.active');
            if (activeBtn) {
                const section = activeBtn.textContent.toLowerCase().replace(/ /g, '');
                const sectionMap = {
                    'setup': 'setup',
                    'monthlytracker': 'monthly',
                    'networth': 'networth',
                    'overview': 'overview',
                    'quarterly': 'quarterly',
                    'subscriptions': 'subscriptions'
                };
                showSection(sectionMap[section] || 'overview');
            }
        }

        function showSection(section, clickedButton) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                // Called programmatically, find the button
                const buttons = document.querySelectorAll('.nav-btn');
                buttons.forEach(btn => {
                    if ((section === 'overview' && btn.textContent.includes('Overview')) ||
                        (section === 'monthly' && btn.textContent.includes('Monthly')) ||
                        (section === 'networth' && btn.textContent.includes('Net Worth')) ||
                        (section === 'quarterly' && btn.textContent.includes('Quarterly')) ||
                        (section === 'subscriptions' && btn.textContent.includes('Subscriptions')) ||
                        (section === 'setup' && btn.textContent.includes('Setup')) ||
                        (section === 'help' && btn.textContent.includes('Help'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            if (section === 'overview') loadOverview();
            if (section === 'setup') loadSetup();
            if (section === 'monthly') loadMonthly();
            if (section === 'networth') loadNetWorth();
            if (section === 'subscriptions') loadSubscriptions();
            if (section === 'quarterly') loadQuarterly();
            // help section is static, no load function needed
        }

        function saveSetup() {
            const data = getData();
            // Remove currency formatting before saving
            const salaryVal = document.getElementById('setup-salary').value.replace(/[$,]/g, '');
            const travelVal = document.getElementById('setup-travel').value.replace(/[$,]/g, '');
            const networthVal = document.getElementById('setup-networth').value.replace(/[$,]/g, '');
            
            data.setup = {
                salary: +salaryVal || 0,
                rate: +document.getElementById('setup-rate').value || 0,
                travel: +travelVal || 0,
                networth: +networthVal || 0
            };
            saveData();
        }

        function loadSetup() {
            const data = getData();
            document.getElementById('setup-salary').value = data.setup.salary;
            document.getElementById('setup-rate').value = data.setup.rate;
            document.getElementById('setup-travel').value = data.setup.travel;
            document.getElementById('setup-networth').value = data.setup.networth;
            
            // Apply currency formatting
            addCurrencyFormatting();
        }

        function calcSubTotal() {
            const data = getData();
            return data.subs.filter(s => s.status === 'Active').reduce((sum, sub) => sum + sub.cost, 0);
        }

        function saveMonthlyCell(monthIdx, type, fieldIdx, value) {
            const data = getData();
            const m = data.monthly[monthIdx];
            
            if (type === 'income' || type === 'expense') {
                m[type][fieldIdx] = +value || 0;
            } else if (type === 'travel') {
                m.travel = +value || 0;
            } else if (type === 'subscriptions') {
                m.subscriptions = +value || 0;
            } else if (type === 'notes') {
                m.notes = value;
            }
            
            saveData();
            loadMonthly(); // Refresh to show updated totals
        }


        function handleMonthlyPaste(event, monthIdx, type, fieldIdx) {
            event.preventDefault();
            
            // Save state for undo before making changes
            saveStateForUndo();
            
            const pastedData = event.clipboardData.getData('text');
            const rows = pastedData.split('\n').filter(row => row.trim());
            
            const data = getData();
            
            rows.forEach((row, rowOffset) => {
                const targetMonthIdx = monthIdx + rowOffset;
                if (targetMonthIdx >= 12) return; // Don't go beyond December
                
                const values = row.split('\t');
                const m = data.monthly[targetMonthIdx];
                
                values.forEach((value, colOffset) => {
                    const targetFieldIdx = fieldIdx + colOffset;
                    
                    // Strip formatting: remove $, commas, spaces, parentheses
                    const cleanValue = value.replace(/[$,\s()]/g, '');
                    
                    if (type === 'income' && targetFieldIdx < m.income.length) {
                        m.income[targetFieldIdx] = parseFloat(cleanValue) || 0;
                    } else if (type === 'expense' && targetFieldIdx < m.expense.length) {
                        m.expense[targetFieldIdx] = parseFloat(cleanValue) || 0;
                    } else if (type === 'travel' && colOffset === 0) {
                        m.travel = parseFloat(cleanValue) || 0;
                    } else if (type === 'subscriptions' && colOffset === 0) {
                        m.subscriptions = parseFloat(cleanValue) || 0;
                    } else if (type === 'notes' && colOffset === 0) {
                        m.notes = value;
                    }
                });
            });
            
            saveData();
            loadMonthly();
        }

        function manageColumns() {
            const data = getData();
            const modal = document.createElement('div');
            modal.id = 'column-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = function(e) {
                if (e.target === modal) closeColumnModal();
            };
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 32px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;';
            
            let html = '<h2 style="margin-bottom: 24px;">Manage Columns</h2>';
            
            // Income columns
            html += '<div style="margin-bottom: 24px;"><h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Income Columns</h3>';
            data.fieldLabels.income.forEach((label, i) => {
                html += `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <input type="text" value="${label.replace(/"/g, '&quot;')}" id="income-${i}" style="flex: 1; padding: 8px;">
                        <button class="btn-danger" data-type="income" data-index="${i}">Delete</button>
                    </div>
                `;
            });
            html += '<button id="add-income-btn" class="btn btn-secondary" style="margin-top: 8px;">+ Add Income Column</button>';
            html += '</div>';
            
            // Expense columns
            html += '<div style="margin-bottom: 24px;"><h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Expense Columns</h3>';
            data.fieldLabels.expense.forEach((label, i) => {
                html += `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <input type="text" value="${label.replace(/"/g, '&quot;')}" id="expense-${i}" style="flex: 1; padding: 8px;">
                        <button class="btn-danger" data-type="expense" data-index="${i}">Delete</button>
                    </div>
                `;
            });
            html += '<button id="add-expense-btn" class="btn btn-secondary" style="margin-top: 8px;">+ Add Expense Column</button>';
            html += '</div>';
            
            html += '<div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">';
            html += '<button id="cancel-column-btn" class="btn btn-secondary">Cancel</button>';
            html += '<button id="save-column-btn" class="btn btn-primary">Save Changes</button>';
            html += '</div>';
            
            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('add-income-btn').addEventListener('click', () => addColumn('income'));
            document.getElementById('add-expense-btn').addEventListener('click', () => addColumn('expense'));
            document.getElementById('cancel-column-btn').addEventListener('click', closeColumnModal);
            document.getElementById('save-column-btn').addEventListener('click', saveColumnChanges);
            
            // Delete button listeners
            modalContent.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteColumn(type, index);
                });
            });
        }
        
        function addColumn(type) {
            const data = getData();
            const newLabel = prompt(`Enter name for new ${type} column:`);
            if (newLabel && newLabel.trim()) {
                data.fieldLabels[type].push(newLabel.trim());
                // Add 0 values to all months for this new column
                data.monthly.forEach(m => m[type].push(0));
                saveData();
                closeColumnModal();
                manageColumns();
            }
        }
        
        function deleteColumn(type, index) {
            if (!confirm('Delete this column? This will remove all data in this column.')) return;
            
            const data = getData();
            data.fieldLabels[type].splice(index, 1);
            // Remove values from all months
            data.monthly.forEach(m => m[type].splice(index, 1));
            saveData();
            closeColumnModal();
            manageColumns();
        }
        
        function saveColumnChanges() {
            const data = getData();
            
            // Update income labels
            data.fieldLabels.income.forEach((_, i) => {
                const input = document.getElementById(`income-${i}`);
                if (input) {
                    data.fieldLabels.income[i] = input.value.trim() || `Income ${i + 1}`;
                }
            });
            
            // Update expense labels
            data.fieldLabels.expense.forEach((_, i) => {
                const input = document.getElementById(`expense-${i}`);
                if (input) {
                    data.fieldLabels.expense[i] = input.value.trim() || `Expense ${i + 1}`;
                }
            });
            
            saveData();
            closeColumnModal();
            loadMonthly();
        }
        
        function closeColumnModal() {
            const modal = document.getElementById('column-modal');
            if (modal) {
                modal.remove();
            }
        }

        function loadMonthly() {
            const data = getData();
            const thead = document.getElementById('monthly-thead');
            const tbody = document.getElementById('monthly-tbody');
            
            // Build header
            let headerHTML = '<tr><th>Month</th>';
            data.fieldLabels.income.forEach(label => {
                headerHTML += `<th class="text-right">${label}</th>`;
            });
            headerHTML += '<th class="text-right" style="background: #dbeafe;">Total Income</th>';
            
            data.fieldLabels.expense.forEach(label => {
                headerHTML += `<th class="text-right">${label}</th>`;
            });
            headerHTML += '<th class="text-right" style="background: #fee2e2;">Total Expenses</th>';
            headerHTML += '<th class="text-right" style="background: #fef3c7;">Travel</th>';
            headerHTML += '<th class="text-right" style="background: #fef3c7;">Subscriptions</th>';
            headerHTML += '<th class="text-right" style="background: #dcfce7;">Net Income</th>';
            headerHTML += '<th class="text-right" style="background: #dcfce7;">Savings %</th>';
            headerHTML += '<th class="text-center">Status</th>';
            headerHTML += '<th style="min-width: 150px;">Notes</th></tr>';
            thead.innerHTML = headerHTML;
            
            // Build rows
            tbody.innerHTML = '';
            data.monthly.forEach((m, idx) => {
                const inc = m.income.reduce((s, v) => s + v, 0);
                const exp = m.expense.reduce((s, v) => s + v, 0);
                const net = inc - exp;
                const rate = inc > 0 ? (net / inc) * 100 : 0;
                const ok = rate >= data.setup.rate;
                const isEmpty = inc === 0 && exp === 0;
                
                const row = tbody.insertRow();
                if (isEmpty) row.classList.add('empty-row');
                
                let html = `<td style="font-weight: 500;">${m.month}</td>`;
                
                // Income fields
                m.income.forEach((val, i) => {
                    html += `<td class="text-right"><input type="number" class="table-input" value="${val || ''}" placeholder="0" onchange="saveMonthlyCell(${idx}, 'income', ${i}, this.value)" onpaste="handleMonthlyPaste(event, ${idx}, 'income', ${i})"></td>`;
                });
                html += `<td class="text-right" style="background: #eff6ff; font-weight: 600;">$${inc.toLocaleString()}</td>`;
                
                // Expense fields
                m.expense.forEach((val, i) => {
                    html += `<td class="text-right"><input type="number" class="table-input" value="${val || ''}" placeholder="0" onchange="saveMonthlyCell(${idx}, 'expense', ${i}, this.value)" onpaste="handleMonthlyPaste(event, ${idx}, 'expense', ${i})"></td>`;
                });
                html += `<td class="text-right" style="background: #fef2f2; font-weight: 600;">$${exp.toLocaleString()}</td>`;
                
                // Travel
                html += `<td class="text-right" style="background: #fefce8;"><input type="number" class="table-input" value="${m.travel || ''}" placeholder="0" onchange="saveMonthlyCell(${idx}, 'travel', 0, this.value)" onpaste="handleMonthlyPaste(event, ${idx}, 'travel', 0)"></td>`;
                
                // Subscriptions (manual entry)
                html += `<td class="text-right" style="background: #fefce8;"><input type="number" class="table-input" value="${m.subscriptions || ''}" placeholder="0" onchange="saveMonthlyCell(${idx}, 'subscriptions', 0, this.value)" onpaste="handleMonthlyPaste(event, ${idx}, 'subscriptions', 0)"></td>`;
                
                // Net, Rate, Status
                html += `<td class="text-right" style="background: #f0fdf4; font-weight: 600;">$${net.toLocaleString()}</td>`;
                html += `<td class="text-right" style="background: #f0fdf4; font-weight: 600;">${rate.toFixed(1)}%</td>`;
                
                if (isEmpty) {
                    html += `<td class="text-center"><span class="status-badge empty">Not Started</span></td>`;
                } else {
                    html += `<td class="text-center">${ok ? '✓ On Target' : '✗ Below Target'}</td>`;
                }
                
                // Notes
                html += `<td><textarea class="table-input" rows="1" placeholder="Notes..." onchange="saveMonthlyCell(${idx}, 'notes', 0, this.value)">${m.notes}</textarea></td>`;
                
                row.innerHTML = html;
            });
            
            // Render the chart
            setTimeout(() => renderNetWorthChart(), 100);
        }

        function addNWField() {
            const data = getData();
            const name = prompt('Enter name for new account:');
            if (name && name.trim()) {
                data.nwLabels.push(name.trim());
                data.networth.forEach(nw => nw.accounts.push(0));
                saveData();
                loadNetWorth();
            }
        }

        function editNWLabel(idx) {
            const data = getData();
            const newName = prompt('Edit account name:', data.nwLabels[idx]);
            if (newName && newName.trim()) {
                data.nwLabels[idx] = newName.trim();
                saveData();
                loadNetWorth();
            }
        }

        function deleteNWField(idx) {
            const data = getData();
            if (confirm('Delete this account field?')) {
                data.nwLabels.splice(idx, 1);
                data.networth.forEach(nw => nw.accounts.splice(idx, 1));
                saveData();
                loadNetWorth();
            }
        }

        function saveNWCell(monthIdx, fieldIdx, value) {
            const data = getData();
            data.networth[monthIdx].accounts[fieldIdx] = +value || 0;
            saveData();
            loadNetWorth(); // Refresh totals
        }


        function handleNWPaste(event, monthIdx, fieldIdx) {
            event.preventDefault();
            
            // Save state for undo before making changes
            saveStateForUndo();
            
            const pastedData = event.clipboardData.getData('text');
            const rows = pastedData.split('\n').filter(row => row.trim());
            
            const data = getData();
            
            rows.forEach((row, rowOffset) => {
                const targetMonthIdx = monthIdx + rowOffset;
                if (targetMonthIdx >= 12) return; // Don't go beyond December
                
                const values = row.split('\t');
                const nw = data.networth[targetMonthIdx];
                
                values.forEach((value, colOffset) => {
                    const targetFieldIdx = fieldIdx + colOffset;
                    
                    // Strip formatting: remove $, commas, spaces, parentheses
                    const cleanValue = value.replace(/[$,\s()]/g, '');
                    
                    if (targetFieldIdx < nw.accounts.length) {
                        nw.accounts[targetFieldIdx] = parseFloat(cleanValue) || 0;
                    }
                });
            });
            
            saveData();
            loadNetWorth();
        }

        function calcNW(idx) {
            const data = getData();
            return data.networth[idx].accounts.reduce((s, v) => s + v, 0);
        }

        let networthChart = null;
        
        function renderNetWorthChart() {
            const data = getData();
            const canvas = document.getElementById('networth-chart');
            
            if (!canvas) return;
            
            // Prepare data
            const months = MONTHS;
            const values = [];
            
            // Starting value
            let previousValue = data.setup.networth;
            
            // Calculate net worth for each month
            for (let i = 0; i < 12; i++) {
                const total = calcNW(i);
                if (total > 0) {
                    values.push(total);
                    previousValue = total;
                } else {
                    // If no data for this month, use previous value
                    values.push(previousValue);
                }
            }
            
            // Destroy existing chart if it exists
            if (networthChart) {
                networthChart.destroy();
            }
            
            // Create chart
            const ctx = canvas.getContext('2d');
            networthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Net Worth',
                        data: values,
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0, 120, 212, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#0078d4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#37352f',
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: {
                                    size: 11
                                },
                                color: '#787774'
                            },
                            grid: {
                                color: '#f0f0f0',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#787774'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function getCurrentNW() {
            const data = getData();
            for (let i = 11; i >= 0; i--) {
                const total = calcNW(i);
                if (total > 0) return total;
            }
            return data.setup.networth;
        }

        function loadNetWorth() {
            const data = getData();
            const current = getCurrentNW();
            const growth = current - data.setup.networth;
            const rate = data.setup.networth > 0 ? (growth / data.setup.networth) * 100 : 0;
            
            document.getElementById('nw-current').textContent = '$' + current.toLocaleString();
            document.getElementById('nw-starting').textContent = '$' + data.setup.networth.toLocaleString();
            document.getElementById('nw-growth').textContent = '$' + growth.toLocaleString();
            document.getElementById('nw-rate').textContent = rate.toFixed(1) + '%';
            
            // Field manager
            const manager = document.getElementById('nw-field-manager');
            manager.innerHTML = '';
            data.nwLabels.forEach((label, i) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; gap: 8px; align-items: center; padding: 8px; background: #f7f7f5; border-radius: 4px; margin-bottom: 8px;';
                div.innerHTML = `
                    <span style="flex: 1; font-size: 14px; font-weight: 500;">${label}</span>
                    <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editNWLabel(${i})">Edit</button>
                    <button class="btn-danger" style="padding: 4px 8px;" onclick="deleteNWField(${i})">Delete</button>
                `;
                manager.appendChild(div);
            });
            
            // Table
            const thead = document.getElementById('nw-thead');
            const tbody = document.getElementById('nw-tbody');
            
            let headerHTML = '<tr><th>Month</th>';
            data.nwLabels.forEach(label => {
                headerHTML += `<th class="text-right">${label}</th>`;
            });
            headerHTML += '<th class="text-right" style="background: #dbeafe;">Total Net Worth</th>';
            headerHTML += '<th class="text-right">Monthly Change</th></tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            data.networth.forEach((nw, idx) => {
                const total = calcNW(idx);
                const prev = idx > 0 ? calcNW(idx - 1) : data.setup.networth;
                const change = total - prev;
                const isEmpty = total === 0;
                
                const row = tbody.insertRow();
                if (isEmpty) row.classList.add('empty-row');
                
                let html = `<td style="font-weight: 500;">${nw.month}</td>`;
                nw.accounts.forEach((val, i) => {
                    html += `<td class="text-right"><input type="number" class="table-input" value="${val || ''}" placeholder="0" onchange="saveNWCell(${idx}, ${i}, this.value)" onpaste="handleNWPaste(event, ${idx}, ${i})"></td>`;
                });
                html += `<td class="text-right" style="background: #eff6ff; font-weight: 600;">$${total.toLocaleString()}</td>`;
                html += `<td class="text-right" style="color: ${change >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">${change >= 0 ? '+' : ''}$${Math.abs(change).toLocaleString()}</td>`;
                
                row.innerHTML = html;
            });
            
            // Render the chart
            setTimeout(() => renderNetWorthChart(), 100);
        }

        function calcMonthStats(m) {
            const inc = m.income.reduce((s, v) => s + v, 0);
            const exp = m.expense.reduce((s, v) => s + v, 0);
            const net = inc - exp;
            const rate = inc > 0 ? (net / inc) * 100 : 0;
            return { inc, exp, net, rate, hasData: inc > 0 || exp > 0 };
        }

        function calcYTD() {
            const data = getData();
            let inc = 0, exp = 0, trv = 0, sub = 0;
            data.monthly.forEach(m => {
                const stats = calcMonthStats(m);
                inc += stats.inc;
                exp += stats.exp;
                trv += m.travel;
                sub += m.subscriptions;
            });
            const net = inc - exp;
            const rate = inc > 0 ? (net / inc) * 100 : 0;
            const months = data.monthly.filter(m => calcMonthStats(m).hasData).length;
            const proj = months > 0 ? (net / months) * 12 : 0;
            const target = data.setup.salary * (data.setup.rate / 100) * 12;
            return { inc, exp, net, rate, trv, sub, proj, target, diff: proj - target, months };
        }

        function loadOverview() {
            const data = getData();
            const ytd = calcYTD();
            const current = getCurrentNW();
            
            // Totals
            document.getElementById('o-income').textContent = '$' + ytd.inc.toLocaleString();
            document.getElementById('o-expenses').textContent = '$' + ytd.exp.toLocaleString();
            document.getElementById('o-saved').textContent = '$' + ytd.net.toLocaleString();
            document.getElementById('o-rate').textContent = ytd.rate.toFixed(1) + '%';
            document.getElementById('o-target-rate').textContent = data.setup.rate;
            
            // Averages
            const avgInc = ytd.months > 0 ? ytd.inc / ytd.months : 0;
            const avgExp = ytd.months > 0 ? ytd.exp / ytd.months : 0;
            const avgSaved = ytd.months > 0 ? ytd.net / ytd.months : 0;
            
            document.getElementById('o-avg-income').textContent = '$' + Math.round(avgInc).toLocaleString();
            document.getElementById('o-avg-expenses').textContent = '$' + Math.round(avgExp).toLocaleString();
            document.getElementById('o-avg-saved').textContent = '$' + Math.round(avgSaved).toLocaleString();
            document.getElementById('o-months').textContent = ytd.months;
            
            // Goals
            const achievement = ytd.target > 0 ? (ytd.net / ytd.target) * 100 : 0;
            document.getElementById('o-goal-target').textContent = '$' + Math.round(ytd.target).toLocaleString();
            document.getElementById('o-goal-actual').textContent = '$' + ytd.net.toLocaleString();
            document.getElementById('o-goal-projected').textContent = '$' + Math.round(ytd.proj).toLocaleString();
            
            const varianceEl = document.getElementById('o-goal-variance');
            varianceEl.textContent = (ytd.diff >= 0 ? '+' : '') + '$' + Math.abs(Math.round(ytd.diff)).toLocaleString();
            varianceEl.style.color = ytd.diff >= 0 ? '#28a745' : '#dc3545';
            
            document.getElementById('o-goal-pct').textContent = Math.round(achievement) + '%';
            document.getElementById('o-goal-bar').style.width = Math.min(achievement, 100) + '%';
            
            // Travel
            const travelRemaining = data.setup.travel - ytd.trv;
            const travelPct = (ytd.trv / data.setup.travel) * 100;
            
            document.getElementById('o-travel-budget').textContent = '$' + data.setup.travel.toLocaleString();
            document.getElementById('o-travel-spent').textContent = '$' + ytd.trv.toLocaleString();
            document.getElementById('o-travel-remaining').textContent = '$' + travelRemaining.toLocaleString();
            document.getElementById('o-travel-pct').textContent = Math.round(travelPct) + '%';
            document.getElementById('o-travel-bar').style.width = Math.min(travelPct, 100) + '%';
            
            const travelStatus = document.getElementById('o-travel-status');
            const travelBar = document.getElementById('o-travel-bar');
            if (ytd.trv <= data.setup.travel) {
                travelStatus.textContent = 'On Budget';
                travelStatus.className = 'status-badge success';
                travelBar.className = 'progress-fill success';
            } else {
                travelStatus.textContent = 'Over Budget';
                travelStatus.className = 'status-badge warning';
                travelBar.className = 'progress-fill danger';
            }
            
            // Monthly table
            const tbody = document.getElementById('overview-tbody');
            tbody.innerHTML = '';
            data.monthly.forEach(m => {
                const stats = calcMonthStats(m);
                const ok = stats.rate >= data.setup.rate;
                const isEmpty = !stats.hasData;
                
                const row = tbody.insertRow();
                if (isEmpty) row.classList.add('empty-row');
                
                row.innerHTML = `
                    <td style="font-weight: 500;">${m.month}</td>
                    <td class="text-right">$${stats.inc.toLocaleString()}</td>
                    <td class="text-right">$${stats.exp.toLocaleString()}</td>
                    <td class="text-right">$${m.travel.toLocaleString()}</td>
                    <td class="text-right">$${m.subscriptions.toLocaleString()}</td>
                    <td class="text-right" style="font-weight: 600;">$${stats.net.toLocaleString()}</td>
                    <td class="text-right" style="font-weight: 600;">${stats.rate.toFixed(1)}%</td>
                    <td class="text-center">${isEmpty ? '—' : (ok ? '✓' : '✗')}</td>
                `;
            });
        }

        function addSubscription() {
            const data = getData();
            data.subs.push({ name: '', cost: 0, status: 'Active', priority: 'Nice-to-Have', link: '' });
            saveData();
            loadSubscriptions();
        }

        function deleteSub(idx) {
            const data = getData();
            data.subs.splice(idx, 1);
            saveData();
            loadSubscriptions();
        }

        function saveSub(idx, field, value) {
            const data = getData();
            data.subs[idx][field] = field === 'cost' ? (+value || 0) : value;
            saveData();
            updateSubTotals();
        }

        function updateMonthlySubscriptions() {
            // No longer auto-updating - user will manually update in monthly tracker
        }

        function updateSubTotals() {
            const data = getData();
            const total = calcSubTotal();
            const activeCount = data.subs.filter(s => s.status === 'Active').length;
            
            document.getElementById('sub-monthly').textContent = '$' + total.toFixed(2);
            document.getElementById('sub-annual').textContent = '$' + (total * 12).toFixed(2);
            document.getElementById('sub-count').textContent = activeCount;
        }

        function loadSubscriptions() {
            const data = getData();
            const tbody = document.getElementById('sub-tbody');
            tbody.innerHTML = '';
            
            data.subs.forEach((sub, i) => {
                const row = tbody.insertRow();
                const linkDisplay = sub.link ? `<a href="${sub.link}" target="_blank" style="color: #0078d4; text-decoration: underline;">Open</a>` : '<span style="color: #9ca3af;">No link</span>';
                row.innerHTML = `
                    <td><input type="text" value="${sub.name}" placeholder="Name" onchange="saveSub(${i}, 'name', this.value)"></td>
                    <td><input type="number" step="0.01" value="${sub.cost || ''}" placeholder="0.00" style="text-align: right;" onchange="saveSub(${i}, 'cost', this.value)"></td>
                    <td>
                        <select onchange="saveSub(${i}, 'status', this.value)">
                            <option value="Active" ${sub.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Paused" ${sub.status === 'Paused' ? 'selected' : ''}>Paused</option>
                            <option value="Cancelled" ${sub.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="saveSub(${i}, 'priority', this.value)">
                            <option value="Essential" ${sub.priority === 'Essential' ? 'selected' : ''}>Essential</option>
                            <option value="Nice-to-Have" ${sub.priority === 'Nice-to-Have' ? 'selected' : ''}>Nice-to-Have</option>
                            <option value="Should Cancel" ${sub.priority === 'Should Cancel' ? 'selected' : ''}>Should Cancel</option>
                        </select>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <input type="url" value="${sub.link || ''}" placeholder="https://..." style="font-size: 12px; padding: 4px 8px;" onchange="saveSub(${i}, 'link', this.value)">
                            ${linkDisplay}
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn-danger" onclick="deleteSub(${i})">Delete</button>
                    </td>
                `;
            });
            
            const footRow = tbody.insertRow();
            footRow.style.borderTop = '2px solid #37352f';
            footRow.style.fontWeight = '600';
            const total = calcSubTotal();
            footRow.innerHTML = `
                <td>TOTAL (Active Only)</td>
                <td class="text-right" style="color: #dc3545; font-size: 15px;">$${total.toFixed(2)}</td>
                <td colspan="4"></td>
            `;
            
            updateSubTotals();
        }

        function clearMonthlyData() {
            if (!confirm('Clear all monthly data? This will reset all income, expenses, travel, subscriptions, and notes to zero. You can undo with Cmd-Z/Ctrl-Z.')) {
                return;
            }
            
            // Save state for undo
            saveStateForUndo();
            
            const data = getData();
            data.monthly.forEach(m => {
                m.income = m.income.map(() => 0);
                m.expense = m.expense.map(() => 0);
                m.travel = 0;
                m.subscriptions = 0;
                m.notes = '';
            });
            
            saveData();
            loadMonthly();
        }
        
        function clearNetWorthData() {
            if (!confirm('Clear all net worth balances? This will reset all account balances to zero. You can undo with Cmd-Z/Ctrl-Z.')) {
                return;
            }
            
            // Save state for undo
            saveStateForUndo();
            
            const data = getData();
            data.networth.forEach(nw => {
                nw.accounts = nw.accounts.map(() => 0);
            });
            
            saveData();
            loadNetWorth();
        }
        
        function clearSubscriptions() {
            if (!confirm('Delete all subscriptions? You can undo with Cmd-Z/Ctrl-Z.')) {
                return;
            }
            
            // Save state for undo
            saveStateForUndo();
            
            const data = getData();
            data.subs = [];
            
            saveData();
            loadSubscriptions();
        }
        
        function loadQuarterly() {
            const data = getData();
            
            for (let q = 0; q < 4; q++) {
                const months = [q * 3, q * 3 + 1, q * 3 + 2];
                let inc = 0, exp = 0, net = 0;
                months.forEach(i => {
                    const stats = calcMonthStats(data.monthly[i]);
                    inc += stats.inc;
                    exp += stats.exp;
                    net += stats.net;
                });
                
                const incGoal = data.setup.salary * 3;
                const netTarget = data.setup.salary * (data.setup.rate / 100) * 3;
                const onTrack = net >= netTarget;
                
                const incPct = incGoal > 0 ? (inc / incGoal) * 100 : 0;
                const expPct = inc > 0 ? (exp / inc) * 100 : 0;
                const savePct = netTarget > 0 ? (net / netTarget) * 100 : 0;
                
                const card = document.getElementById(`q${q + 1}-card`);
                card.innerHTML = `
                    <div style="padding: 32px; background: white; border-radius: 4px; border: 1px solid #e9e9e7; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #37352f;">Q${q + 1} ${['JAN-MAR', 'APR-JUN', 'JUL-SEP', 'OCT-DEC'][q]}</h3>
                            <span style="font-size: 28px; color: ${onTrack ? '#28a745' : '#dc3545'};">${onTrack ? '✓' : '✗'}</span>
                        </div>
                        
                        <div style="background: #f7f7f5; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #787774; text-transform: uppercase;">Total Income</span>
                                <span style="font-size: 14px; font-weight: 600; color: #0078d4;">$${inc.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar" style="height: 10px;">
                                <div class="progress-fill" style="width: ${Math.min(incPct, 100)}%; background: linear-gradient(90deg, #0078d4 0%, #005a9e 100%);"></div>
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Target: $${incGoal.toLocaleString()} (${Math.round(incPct)}%)</div>
                        </div>
                        
                        <div style="background: #f7f7f5; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #787774; text-transform: uppercase;">Total Expenses</span>
                                <span style="font-size: 14px; font-weight: 600; color: #dc3545;">$${exp.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar" style="height: 10px;">
                                <div class="progress-fill" style="width: ${Math.min(expPct, 100)}%; background: linear-gradient(90deg, #dc3545 0%, #b91c1c 100%);"></div>
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">${Math.round(expPct)}% of income spent</div>
                        </div>
                        
                        <div style="background: #f7f7f5; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #787774; text-transform: uppercase;">Net Savings</span>
                                <span style="font-size: 14px; font-weight: 600; color: #28a745;">$${net.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar" style="height: 10px;">
                                <div class="progress-fill" style="width: ${Math.min(savePct, 100)}%; background: linear-gradient(90deg, #28a745 0%, #16a34a 100%);"></div>
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Target: $${netTarget.toLocaleString()} (${Math.round(savePct)}%)</div>
                        </div>
                        
                        <div class="status-badge ${onTrack ? 'success' : 'warning'}" style="width: 100%; justify-content: center; padding: 10px; font-size: 13px; letter-spacing: 0.5px;">
                            ${onTrack ? 'ON TRACK ✓' : 'NEEDS ATTENTION'}
                        </div>
                    </div>
                `;
            }
        }

        // Export/Import Functions
        function exportData() {
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `financial-tracker-backup-${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Data exported successfully! Save this file in a safe place (Google Drive, Dropbox, etc.)');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('Invalid data format - not a valid JSON object');
                    }
                    
                    // Check if it has at least one year of data
                    const years = Object.keys(importedData);
                    if (years.length === 0) {
                        throw new Error('No data found in backup file');
                    }
                    
                    // Validate structure of first year
                    const firstYear = importedData[years[0]];
                    if (!firstYear.setup || !firstYear.monthly || !firstYear.networth) {
                        throw new Error('Invalid backup file structure - missing required data');
                    }
                    
                    // Confirm before overwriting
                    if (confirm('This will replace all current data. Are you sure you want to import?')) {
                        allData = importedData;
                        saveData();
                        
                        // Reinitialize the app
                        initYearSelector();
                        updateAllYearLabels();
                        
                        // Load overview for current year
                        loadOverview();
                        
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message + '\nPlease make sure you selected a valid backup file.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset the file input so the same file can be imported again if needed
            event.target.value = '';
        }

        // CSV Import Functions
        function downloadCSVTemplate() {
            const data = getData();
            let csv = 'Month';
            
            // Add income headers
            data.fieldLabels.income.forEach(label => {
                csv += ',' + label;
            });
            
            // Add expense headers
            data.fieldLabels.expense.forEach(label => {
                csv += ',' + label;
            });
            
            // Add other headers
            csv += ',Travel,Subscriptions,Notes\n';
            
            // Add example row
            csv += 'January,0,0,0,0,0,0,0,0,0,0,"Optional notes here"';
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `monthly-tracker-template-${currentYear}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('CSV file is empty or invalid');
                    }
                    
                    // Parse header
                    const headers = parseCSVLine(lines[0]);
                    
                    // Validate header structure
                    if (!headers[0] || headers[0].toLowerCase() !== 'month') {
                        throw new Error('First column must be "Month"');
                    }
                    
                    const data = getData();
                    let importedCount = 0;
                    
                    // Parse data rows
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue; // Skip empty lines
                        
                        const values = parseCSVLine(lines[i]);
                        if (values.length === 0) continue;
                        
                        // Find month index
                        const monthName = values[0].trim();
                        const monthIdx = MONTHS.findIndex(m => m.toLowerCase() === monthName.toLowerCase() || m.toLowerCase().startsWith(monthName.toLowerCase()));
                        
                        if (monthIdx === -1) {
                            console.warn(`Skipping unknown month: ${monthName}`);
                            continue;
                        }
                        
                        const m = data.monthly[monthIdx];
                        let colIdx = 1;
                        
                        // Import income fields
                        for (let j = 0; j < data.fieldLabels.income.length; j++) {
                            m.income[j] = parseFloat(values[colIdx]) || 0;
                            colIdx++;
                        }
                        
                        // Import expense fields
                        for (let j = 0; j < data.fieldLabels.expense.length; j++) {
                            m.expense[j] = parseFloat(values[colIdx]) || 0;
                            colIdx++;
                        }
                        
                        // Import travel
                        m.travel = parseFloat(values[colIdx]) || 0;
                        colIdx++;
                        
                        // Import subscriptions
                        m.subscriptions = parseFloat(values[colIdx]) || 0;
                        colIdx++;
                        
                        // Import notes
                        if (values[colIdx]) {
                            m.notes = values[colIdx].trim();
                        }
                        
                        importedCount++;
                    }
                    
                    if (importedCount === 0) {
                        throw new Error('No valid data rows found in CSV');
                    }
                    
                    saveData();
                    loadMonthly();
                    
                    alert(`Successfully imported ${importedCount} month(s) of data!`);
                    
                } catch (error) {
                    alert('Error importing CSV: ' + error.message + '\n\nMake sure your CSV matches the template format.');
                    console.error('CSV import error:', error);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(v => v.replace(/^"|"$/g, '').trim());
        }

        // Currency formatting helper
        function formatCurrency(input) {
            let value = input.value;
            // Remove any non-numeric characters except decimal point and minus
            value = value.replace(/[^0-9.-]/g, '');
            
            // If there's a value, format it
            if (value && value !== '' && value !== '-') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    // Format with $ and commas
                    input.value = '$' + numValue.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    });
                }
            }
        }
        
        function unformatCurrency(input) {
            // Remove $ and commas for editing
            input.value = input.value.replace(/[$,]/g, '');
        }
        
        // Add currency formatting to Setup inputs on focus/blur
        function addCurrencyFormatting() {
            const currencyInputs = [
                'setup-salary',
                'setup-travel',
                'setup-networth'
            ];
            
            currencyInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('focus', function() {
                        unformatCurrency(this);
                    });
                    input.addEventListener('blur', function() {
                        formatCurrency(this);
                    });
                    // Format on load
                    formatCurrency(input);
                }
            });
        }
        
        // Initialize
        loadData();
        initYearSelector();
        updateAllYearLabels();
        
        // Show Overview by default (it's now the first tab)
        document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
        document.getElementById('overview-section').classList.remove('hidden');
        loadOverview();
        
        // Add currency formatting to setup inputs
        setTimeout(addCurrencyFormatting, 100);
    </script>
</body>
</html>